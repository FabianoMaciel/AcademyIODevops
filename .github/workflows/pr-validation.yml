name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ master, main, develop ]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: üìã PR Details
      run: |
        echo "## üìã Pull Request Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
        echo "**Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "**Base Branch:** ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Head Branch:** ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Changed Files:** ${{ github.event.pull_request.changed_files }}" >> $GITHUB_STEP_SUMMARY
        echo "**Additions:** +${{ github.event.pull_request.additions }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deletions:** -${{ github.event.pull_request.deletions }}" >> $GITHUB_STEP_SUMMARY

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ Restore dependencies
      run: dotnet restore AcademyIODevops.sln

    - name: üèóÔ∏è Build solution
      run: dotnet build AcademyIODevops.sln --configuration Release --no-restore

    - name: üîç Check for compiler warnings
      run: |
        BUILD_OUTPUT=$(dotnet build AcademyIODevops.sln --configuration Release --no-restore 2>&1)
        WARNING_COUNT=$(echo "$BUILD_OUTPUT" | grep -c "warning CS" || true)

        echo "## üîç Compiler Warnings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Total warnings: **$WARNING_COUNT**" >> $GITHUB_STEP_SUMMARY

        if [ $WARNING_COUNT -gt 50 ]; then
          echo "‚ö†Ô∏è High number of warnings detected!" >> $GITHUB_STEP_SUMMARY
        fi

  changed-files:
    name: Analyze Changed Files
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üìù Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v42
      with:
        files: |
          src/**/*.cs
          tests/**/*.cs

    - name: üìä Analyze changes
      run: |
        echo "## üìÅ Changed Files Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total changed files:** ${{ steps.changed-files.outputs.all_changed_files_count }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.changed-files.outputs.all_changed_files_count }}" -gt 50 ]; then
          echo "‚ö†Ô∏è **Large PR detected!** Consider breaking it into smaller PRs." >> $GITHUB_STEP_SUMMARY
        fi

        echo "### Changed Files:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.changed-files.outputs.all_changed_files }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: üß™ Check if tests were added
      run: |
        TEST_FILES_CHANGED=${{ steps.changed-files.outputs.all_changed_files }}
        SRC_CHANGED=$(echo "$TEST_FILES_CHANGED" | grep -c "src/" || true)
        TEST_CHANGED=$(echo "$TEST_FILES_CHANGED" | grep -c "tests/" || true)

        echo "## üß™ Test Coverage Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Source files changed: **$SRC_CHANGED**" >> $GITHUB_STEP_SUMMARY
        echo "Test files changed: **$TEST_CHANGED**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ $SRC_CHANGED -gt 0 ] && [ $TEST_CHANGED -eq 0 ]; then
          echo "‚ö†Ô∏è **Warning:** Source files were modified but no test files were changed." >> $GITHUB_STEP_SUMMARY
          echo "Consider adding tests for your changes." >> $GITHUB_STEP_SUMMARY
        else
          echo "‚úÖ Tests were included with code changes." >> $GITHUB_STEP_SUMMARY
        fi

  test-coverage-pr:
    name: PR Test Coverage
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: üì• Checkout PR code
      uses: actions/checkout@v4

    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ Restore dependencies
      run: dotnet restore AcademyIODevops.sln

    - name: üß™ Run tests with coverage
      run: |
        dotnet test AcademyIODevops.sln \
          --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: üìä Generate coverage report
      uses: danielpalme/ReportGenerator-GitHub-Action@5.2.4
      with:
        reports: 'coverage/**/coverage.cobertura.xml'
        targetdir: 'coveragereport'
        reporttypes: 'MarkdownSummaryGithub;JsonSummary'

    - name: üìà Post coverage to PR
      run: |
        cat coveragereport/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

        COVERAGE=$(jq -r '.summary.linecoverage' coveragereport/Summary.json)
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total Line Coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ Restore dependencies
      run: dotnet restore AcademyIODevops.sln

    - name: üèóÔ∏è Build solution (Debug)
      run: dotnet build AcademyIODevops.sln --configuration Debug --no-restore

    - name: üèóÔ∏è Build solution (Release)
      run: dotnet build AcademyIODevops.sln --configuration Release --no-restore

    - name: ‚úÖ Build success
      run: |
        echo "## ‚úÖ Build Check Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Both Debug and Release builds completed successfully." >> $GITHUB_STEP_SUMMARY

  # pr-labels job removed - manual labeling only

  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-info, code-quality, changed-files, test-coverage-pr, build-check]
    if: always() && github.event.pull_request.draft == false

    steps:
    - name: ‚úÖ All checks passed
      if: ${{ needs.code-quality.result == 'success' && needs.build-check.result == 'success' && needs.test-coverage-pr.result == 'success' }}
      run: |
        echo "## ‚úÖ PR Validation Passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All validation checks passed. PR is ready for review." >> $GITHUB_STEP_SUMMARY

    - name: ‚ö†Ô∏è Some checks failed
      if: ${{ needs.code-quality.result != 'success' || needs.build-check.result != 'success' || needs.test-coverage-pr.result != 'success' }}
      run: |
        echo "## ‚ö†Ô∏è PR Validation Issues" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Some validation checks failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: pr-validation-summary
    if: always() && github.event.pull_request.draft == false
    permissions:
      pull-requests: write

    steps:
    - name: üí¨ Comment PR status
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ needs.pr-validation-summary.result }}';
          const emoji = status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
          const message = status === 'success'
            ? 'All PR validation checks passed! Ready for review.'
            : 'Some PR validation checks failed. Please review the logs.';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${emoji} **PR Validation:** ${message}\n\n[View detailed results](${context.payload.pull_request.html_url}/checks)`
          });
