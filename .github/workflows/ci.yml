name: CI - Build and Test

on:
  push:
    branches: [ master, develop, main ]
  pull_request:
    branches: [ master, develop, main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for better analysis

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore AcademyIODevops.sln

    - name: ðŸ—ï¸ Build solution
      run: dotnet build AcademyIODevops.sln --configuration Release --no-restore

    - name: ðŸ§ª Run unit tests
      run: dotnet test AcademyIODevops.sln --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: ðŸ“Š Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: true

    - name: ðŸ“ˆ Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        dotnet test AcademyIODevops.sln --configuration Release --no-build --verbosity quiet --logger "console;verbosity=detailed" || true

  build-matrix:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
      fail-fast: false

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore AcademyIODevops.sln

    - name: ðŸ—ï¸ Build solution
      run: dotnet build AcademyIODevops.sln --configuration Release --no-restore

    - name: âœ… Verify build artifacts
      shell: bash
      run: |
        echo "Build completed successfully on ${{ matrix.os }}"
        echo "Checking for build artifacts..."
        if [ -d "src" ]; then
          find src -type d -name "Release" 2>/dev/null || echo "No Release directories found (this is OK)"
        else
          echo "src directory not found"
        fi

  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore AcademyIODevops.sln

    - name: ðŸ” Run code analysis
      run: dotnet build AcademyIODevops.sln --configuration Release --no-restore /p:TreatWarningsAsErrors=false

    - name: ðŸ“‹ Check for build warnings
      run: |
        echo "## ðŸ” Code Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "Build completed. Check logs for any warnings." >> $GITHUB_STEP_SUMMARY

  stylecop-lint:
    name: StyleCop Linting
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore AcademyIODevops.sln

    - name: ðŸŽ¨ Run StyleCop analysis
      run: |
        dotnet build AcademyIODevops.sln --configuration Release --no-restore /p:EnforceCodeStyleInBuild=true > stylecop.log 2>&1 || true

    - name: ðŸ“Š Check StyleCop violations
      run: |
        VIOLATIONS=$(grep -c "warning SA" stylecop.log || true)
        ERRORS=$(grep -c "error SA" stylecop.log || true)

        echo "## ðŸŽ¨ StyleCop Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Warnings:** $VIOLATIONS" >> $GITHUB_STEP_SUMMARY
        echo "**Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ $ERRORS -gt 0 ]; then
          echo "âŒ StyleCop errors found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Error Details:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep "error SA" stylecop.log | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          exit 1
        elif [ $VIOLATIONS -gt 100 ]; then
          echo "âš ï¸ High number of StyleCop warnings ($VIOLATIONS)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… StyleCop analysis passed" >> $GITHUB_STEP_SUMMARY
        fi

  status-check:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: [build-and-test, build-matrix, analyze, stylecop-lint]
    if: always()

    steps:
    - name: âœ… All checks passed
      if: ${{ needs.build-and-test.result == 'success' && needs.build-matrix.result == 'success' && needs.analyze.result == 'success' && needs.stylecop-lint.result == 'success' }}
      run: |
        echo "## âœ… CI Pipeline Passed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All checks completed successfully." >> $GITHUB_STEP_SUMMARY

    - name: âŒ Some checks failed
      if: ${{ needs.build-and-test.result != 'success' || needs.build-matrix.result != 'success' || needs.analyze.result != 'success' || needs.stylecop-lint.result != 'success' }}
      run: |
        echo "## âŒ CI Pipeline Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Some checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
        exit 1
